apply plugin: 'jacoco'

def coverageExcludes = [
        '**/R.class',
        '**/R$*.class',
        '**/BuildConfig.*',
        '**/Manifest*.*',
        '**/*Test*.*',
        'android/**/*.*',
        '**/*$ViewInjector*.*',
        '**/*$ViewBinder*.*',
        '**/*$Lambda$*.*', // Jacoco can not handle several "$" in class name.
        '**/*$inlined$*.*', // Kotlin specific, Jacoco can not handle several "$" in class name.
        '**/*Module.*', // Modules for Dagger.
        '**/*Dagger*.*', // Dagger auto-generated code.
        '**/*MembersInjector*.*', // Dagger auto-generated code.
        '**/*__MembersInjector',
        '**/*_Provide*Factory*.*'
]

def coverageSourceDirs = []
def taskList = []
def coverageClassDirectories = []
def modulesList = [Modules.app, Modules.coreDomain, Modules.corePresentation, Modules.coreDomain,
                   Modules.featureA]
def executionDataList = []

jacoco {
    toolVersion = "0.8.7"
}

modulesList.each { module ->
    taskList.add("$module:jacocoTestReport")
    coverageSourceDirs.add("$module/src/main/java")
    //coverageClassDirectories.add(fileTree(dir: "$module/build/intermediates/classes/bahia/debug", excludes: coverageExcludes))//Apenas para java
    coverageClassDirectories.add(fileTree(dir: "$module/build/tmp/kotlin-classes/debug", excludes: coverageExcludes))
}

task jacocoMergeReport(type: JacocoReport) {
    dependsOn taskList

    taskList.each { executionDataList.add(tasks.getByPath(it).executionData) }

    additionalSourceDirs.setFrom(files(coverageSourceDirs))
    sourceDirectories.setFrom(files(coverageSourceDirs))
    classDirectories.setFrom(files(coverageClassDirectories))
    executionData.setFrom(files(executionDataList))

    reports {
        html.enabled = true
        xml.enabled = true
        csv.enabled = false
    }
    onlyIf = {
        true
    }

    doFirst {
        def data = files(executionData.findAll {
            it.exists()
        })
        executionData.setFrom(data)
    }
}

tasks.withType(Test) {
    jacoco.includeNoLocationClasses = true
}